import json
from fpdf import FPDF
import os

def generate_pdf_report(scan_data, filename="results/scan_report.pdf"):
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", size=12)

    pdf.cell(200, 10, txt="Vulnerability Scan Report", ln=True, align='C')
    pdf.ln(10)
    pdf.cell(200, 10, txt=f"Target: {scan_data['ip']}", ln=True)
    pdf.cell(200, 10, txt=f"Scan Time: {scan_data['scanned_at']}", ln=True)
    pdf.cell(200, 10, txt=f"Operating System Guess: {scan_data['os']}", ln=True)
    pdf.cell(200, 10, txt=f"Time Taken: {scan_data['time_taken']} seconds", ln=True)

    pdf.ln(10)
    pdf.set_font("Arial", size=10)
    for port, info in scan_data['ports'].items():
        pdf.multi_cell(0, 10, txt=f"Port {port} ({info['name']}): {info['state']}\n  Banner: {info['banner']}\n  Vulnerability Hint: {info['vuln_hint']}\n  CVEs: {', '.join(info['cves']) if info['cves'] else 'None'}")
        pdf.ln(1)

    os.makedirs(os.path.dirname(filename), exist_ok=True)
    pdf.output(filename)
    return filename

def export_scan_json(scan_data, filename="results/scan_export.json"):
    os.makedirs(os.path.dirname(filename), exist_ok=True)
    with open(filename, "w") as f:
        json.dump(scan_data, f, indent=4)
    return filename
